name: Build and Push Docker Image

on:
  push:
    branches:
      - main
      - dev
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_USERNAME: xzixmn
  IMAGE_NAME: cloudgather

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract metadata
        id: meta
        run: |
          # ä» version.py æ–‡ä»¶è¯»å–ç‰ˆæœ¬å·
          VERSION=$(python3 -c "exec(open('version.py').read()); print(__version__)")
          
          # ç¡®å®šæ ‡ç­¾å’Œæ˜¯å¦æ¨é€ç‰ˆæœ¬å·
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # å¦‚æœæ˜¯ tag æ¨é€ï¼Œä½¿ç”¨ tag åç§°
            TAG=${GITHUB_REF#refs/tags/}
            PUSH_VERSION="true"
          elif [[ $GITHUB_REF == refs/heads/main ]]; then
            # main åˆ†æ”¯æ¨é€ä¸º latest + ç‰ˆæœ¬å·
            TAG="latest"
            PUSH_VERSION="true"
          elif [[ $GITHUB_REF == refs/heads/dev ]]; then
            # dev åˆ†æ”¯åªæ¨é€ betaï¼Œä¸æ¨ç‰ˆæœ¬å·
            TAG="beta"
            PUSH_VERSION="false"
          else
            # å…¶ä»–æƒ…å†µä½¿ç”¨ commit SHA
            TAG="sha-${GITHUB_SHA::8}"
            PUSH_VERSION="false"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "push_version=${PUSH_VERSION}" >> $GITHUB_OUTPUT
          echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ steps.meta.outputs.push_version == 'true' && format('{0}/{1}:v{2}', env.DOCKER_USERNAME, env.IMAGE_NAME, steps.meta.outputs.version) || '' }}
          build-args: |
            VERSION=${{ steps.meta.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=CloudGather
            org.opencontainers.image.description=åª’ä½“æ–‡ä»¶åŒæ­¥å·¥å…· - NAS Media Sync Tool
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.created=${{ steps.meta.outputs.date }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
      
      - name: Image digest
        run: echo "Image pushed successfully! ğŸš€"
